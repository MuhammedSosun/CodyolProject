generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // mysql / sqlite ise deƒüi≈ütir
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

model User {
  id       String @id @default(uuid())
  username String @unique
  email    String @unique
  password String
  role     Role   @default(USER)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  ownedCustomers Customer[] @relation("CustomerOwner")

  // ‚úÖ EKLENDƒ∞
  assignedTasks Task[]

  // ‚úÖ EKLENDƒ∞
  createdActivities Activity[]

  refreshTokens RefreshToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
}

model RefreshToken {
  id           String   @id @default(uuid())
  refreshToken String   @unique
  expiredAt    DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Organization {
  id String @id @default(uuid())

  // Identity
  name             String
  slug             String           @unique
  organizationType OrganizationType

  // Business info
  legalName String?
  industry  String?
  website   String?
  email     String?
  phone     String?

  // Subscription
  planType PlanType @default(FREE)
  isActive Boolean  @default(true)

  // Ownership (Auth / Super Admin)
  ownerUserId String

  // Relations
  users      User[]
  customers  Customer[]
  activities Activity[]
  tasks      Task[]

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([ownerUserId])
  @@index([isActive])
  @@index([deletedAt])
}

enum OrganizationType {
  COMPANY
  CLUB
  NGO
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

model Customer {
  id String @id @default(uuid())

  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Ownership (CRM i√ßi sorumlu)
  ownerUserId String
  owner       User   @relation("CustomerOwner", fields: [ownerUserId], references: [id])

  // Personal / Company Info
  fullName    String
  email       String?
  phone       String?
  companyName String?
  vatNumber   String?
  website     String?
  address     String?
  description String?
  designation String?

  // CRM lifecycle
  status CustomerStatus @default(NEW)

  // Relations
  activities Activity[]
  tasks      Task[]

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([organizationId])
  @@index([ownerUserId])
  @@index([status])
  @@index([deletedAt])
}

enum CustomerStatus {
  NEW // Yeni
  CONTACTED // ƒ∞leti≈üim Kuruldu
  OFFER_SENT // Teklif G√∂nderildi
  WAITING_APPROVAL // Onay Bekliyor
  APPROVED // Onaylandƒ±
  WON // Kazanƒ±ldƒ±
  LOST // Kaybedildi
}

model Task {
  id String @id @default(uuid())

  // üåç Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // üë§ Sorumlu Ki≈üi
  assignedUserId String
  assignedUser   User   @relation(fields: [assignedUserId], references: [id])

  // üë• Customer (opsiyonel)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // üßæ Task bilgileri
  title       String
  description String?

  // üìÖ Tarihler
  startDate DateTime?
  endDate   DateTime?

  // üö¶ Durum
  status TaskStatus @default(NEW)

  // ‚úÖ EKLENDƒ∞
  activities Activity[]

  // üïí Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // ‚ö° Indexler
  @@index([organizationId])
  @@index([assignedUserId])
  @@index([customerId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([deletedAt])
}

enum TaskStatus {
  NEW // Yeni
  IN_PROGRESS // Devam Ediyor
  ON_HOLD // Beklemede
  COMPLETED // Tamamlandƒ±
}

model Activity {
  id String @id @default(uuid())

  // üåç Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // üë§ Kim yaptƒ±
  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id])

  // ‚úÖ Task ili≈ükisi (EKLENDƒ∞)
  taskId String?
  task   Task?   @relation(fields: [taskId], references: [id])

  // üß† Aktivite bilgisi
  type        ActivityType
  title       String
  description String?

  // üïí Audit
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  // ‚ö° Performans indexleri
  @@index([organizationId])
  @@index([customerId])
  @@index([createdByUserId])
  @@index([type])
  @@index([deletedAt])
  @@index([taskId]) // ‚úÖ
}

enum ActivityType {
  // Manuel
  CALL
  EMAIL
  NOTE
  MEETING

  // Sistem olaylarƒ±
  TASK_CREATED
  TASK_UPDATED
  TASK_STATUS_CHANGED
  TASK_COMPLETED

  CUSTOMER_CREATED
  CUSTOMER_UPDATED
}
