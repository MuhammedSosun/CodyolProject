generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // mysql / sqlite ise deÄŸiÅŸtir
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

model User {
  id       String @id @default(uuid())
  username String @unique
  email    String @unique
  password String
  role     Role   @default(USER)

  ownedCustomers    Customer[]     @relation("CustomerOwner")
  assignedTasks     Task[]
  createdActivities Activity[]
  profile           Profile?
  refreshTokens     RefreshToken[]
  teamMemberships   TeamMember[]
  transactions      Transaction[]  @relation("UserTransactions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deletedAt DateTime?
}

model RefreshToken {
  id           String   @id @default(uuid())
  refreshToken String   @unique
  expiredAt    DateTime

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum PlanType {
  FREE
  PRO
  ENTERPRISE
}

model Customer {
  id String @id @default(uuid())

  ownerUserId String
  owner       User   @relation("CustomerOwner", fields: [ownerUserId], references: [id])

  fullName    String
  email       String?
  phone       String?
  companyName String?
  vatNumber   String?
  website     String?
  address     String?
  description String?
  designation String?

  status CustomerStatus @default(NEW)

  activities   Activity[]
  tasks        Task[]
  proposals    Proposal[]
  transactions Transaction[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([ownerUserId])
  @@index([status])
  @@index([deletedAt])
}

enum CustomerStatus {
  NEW // Yeni
  CONTACTED // Ä°letiÅŸim Kuruldu
  OFFER_SENT // Teklif GÃ¶nderildi
  WAITING_APPROVAL // Onay Bekliyor
  APPROVED // OnaylandÄ±
  WON // KazanÄ±ldÄ±
  LOST // Kaybedildi
}

model Task {
  id String @id @default(uuid())

  assignedUserId String
  assignedUser   User   @relation(fields: [assignedUserId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  title       String
  description String?

  startDate DateTime?
  endDate   DateTime?

  status TaskStatus @default(NEW)

  activities Activity[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([assignedUserId])
  @@index([customerId])
  @@index([status])
  @@index([deletedAt])
}

enum TaskStatus {
  NEW
  IN_PROGRESS
  ON_HOLD
  COMPLETED
}

model Activity {
  id String @id @default(uuid())

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  createdByUserId String?
  createdByUser   User?   @relation(fields: [createdByUserId], references: [id])

  taskId String?
  task   Task?   @relation(fields: [taskId], references: [id])

  type        ActivityType
  title       String
  description String?

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([customerId])
  @@index([createdByUserId])
  @@index([type])
  @@index([taskId])
}

enum ActivityType {
  CALL
  EMAIL
  NOTE
  MEETING

  TASK_CREATED
  TASK_UPDATED
  TASK_STATUS_CHANGED
  TASK_COMPLETED

  CUSTOMER_CREATED
  CUSTOMER_UPDATED

  PROPOSAL_CREATED
  PROPOSAL_STATUS_CHANGED
}

model Proposal {
  id String @id @default(uuid())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  title      String
  status     ProposalStatus @default(DRAFT)
  validUntil DateTime

  totalAmount  Decimal?      @db.Decimal(12, 2)
  currency    String @default("TRY")
  transactions Transaction[]

  createdByUserId String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  @@index([customerId])
}

enum ProposalStatus {
  DRAFT // Taslak
  SENT // GÃ¶nderildi
  EXPIRED // SÃ¼resi Doldu
  REJECTED // Reddedildi
  APPROVED // Kabul Edildi
}


model Profile {
  id String @id @default(uuid())

  // ðŸ”— One-to-One
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ðŸ‘¤ KiÅŸisel bilgiler
  firstName String?
  lastName  String?
  phone     String?
  bio       String?
  position  String?

  // ðŸ•’ Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Team {
  id   String @id @default(uuid())
  name String @unique

  members TeamMember[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}

model TeamMember {
  id String @id @default(uuid())

  teamId String
  userId String

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Ä°stersen ekip iÃ§i rol (opsiyonel)
  role String?

  createdAt DateTime @default(now())

  @@unique([teamId, userId]) // aynÄ± user aynÄ± team'e 2 kere eklenmesin
  @@index([teamId])
  @@index([userId])
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  OTHER
}

model Transaction {
  id String @id @default(uuid())

  type     TransactionType
  amount   Decimal         @db.Decimal(12, 2)
  currency String          @default("TRY")

  date DateTime @default(now())

  description String?
  category    String? // MVP: string kategori, ÅŸiÅŸirmiyoruz

  paymentMethod PaymentMethod @default(BANK_TRANSFER)
  referenceNo   String? // fiÅŸ / dekont no (opsiyonel)

  // Optional iliÅŸkilendirme
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  proposalId String?
  proposal   Proposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  // Kim ekledi?
  createdByUserId String
  createdByUser   User   @relation("UserTransactions", fields: [createdByUserId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([type])
  @@index([date])
  @@index([customerId])
  @@index([proposalId])
  @@index([createdByUserId])
  @@index([deletedAt])
}
